{"pageProps":{"post":{"fileName":"2019-08-14-building-a-website-on-s3.md","fullPath":"/home/runner/work/rusith.me/rusith.me/modules/blog/posts/2019-08-14-building-a-website-on-s3.md","title":"Deploying a Website on S3 With SSL, Continuous Integration","tags":["aws","programming","web"],"comments":true,"description":"In this post, I am creating a website and host it on S3 and setup a continuous integration pipeline setup using Gitlab","dateCreated":"Mon Aug 05 2019 00:00:00 GMT+0000 (Coordinated Universal Time)","dateModified":"Mon Aug 05 2019 00:00:00 GMT+0000 (Coordinated Universal Time)","datePublished":"Mon Aug 05 2019 00:00:00 GMT+0000 (Coordinated Universal Time)","dependencies":"AWS","about":"Demonstrates how to create and publish a website on S3 and create a CI setup for automatic deployments","banner":"/post-data/2019-08-14-building-a-website-on-s3/banner.png","path":"/blog/building-a-website-on-s3","oldPath":"/2019/08/14/building-a-website-on-s3","dateCreatedFormatted":"Mon, Aug 5, 2019","fullUrl":"https://rusith.me/blog/building-a-website-on-s3","fileContent":"---\ntitle: Deploying a Website on S3 With SSL, Continuous Integration\ntags: aws programming web\ncomments: true\ndescription: In this post, I am creating a website and host it on S3 and setup a continuous integration pipeline setup using Gitlab\ndateCreated: 2019-08-05\ndateModified: 2019-08-05\ndatePublished: 2019-08-05\ndependencies: AWS\nabout: Demonstrates how to create and publish a website on S3 and create a CI setup for automatic deployments\nbanner: /post-data/2019-08-14-building-a-website-on-s3/banner.png\npath: /building-a-website-on-s3\noldPath: /2019/08/14/building-a-website-on-s3\n---\n\n<img alt=\"Page banner\" class=\"$$styles.banner\" src=\"$$page_banner_full_path\" >\n\nS3 supports static site hosting, In this post, I am going to show you how you can set up a website on S3 and configure\na deployment workflow using Gitlab.\n\nWhat we can expect from the site that we gonna create?\n\n- It should be fast\n- Should have a proper SSL certificate\n- Should be able to update the site right from GIT\n\n### What we are Going to use\n\nLet's see what tools we are going to use to make this happen, Most of these tools are either free or very cost-effective for a\nsimple website. So you can give this a try without any worries. Anyway, it's better to check the pricing and get an understanding before proceeding.\n\nWe are going to spend most of the time in AWS. so if you have not used AWS before, create an account if you want to follow\nalone.\n\n##### A domain name service\n\nI am going to use Godaddy. but you can use any service for this. We use this only to buy the domain.\nafter adding the name server records, we won't touch this much.\n\n##### Amazon Route 53\n\nWe are going to use Amazon Route 53 as the name server for our domain.\n\n##### Amazon Certificate Manager\n\nWe will need the Certificate Manager to get an SSL certificate for our website\n\n##### Amazon Cloudfront\n\nWe have to use a Cloudfront distribution for our website.\n\n##### Amazon S3\n\nWe are going to use S3 to put the files of the website (the site itself)\n\n##### Gitlab\n\nWe will use Gitlab to host our code and create the CI pipeline. create a new account if you haven't used it before if you want to follow along. its free.\n\n### Getting a Domain Name Ready\n\nIf you have a domain name already, skip this step. You can use any domain name service as you like such as NameCheap, BlueHost.\n\nI already have a domain that can be used in this which is `prettyuseless.website`.\nThe name is awful but let's continue with it.\n\nSo I have my domain name with me, make sure you have your one ready at this point if you follow along.\n\n### Creating the S3 Bucket\n\nOkay, we need a place to put the files of our website (such as `index.html`). we are going to use Amazon S3 for this.\nFirst, we have to create a bucket for our website. Make sure to set the domain name as the name of the new bucket.\n\n_Go to S3 home page, and start creating the bucket. put your domain name as the name and choose your preferred region.\n(I am choosing Singapore) and go head_\n\n<img alt=\"Create a bucket\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/create-bucket-step-one.jpg\">\n\nAfter creating the bucket, It should immediately show up in the S3 home page.\n\n_Click the bucket you just created and go to permissions tab. Click the \"Bucket Policy\" button and paste the configuration below_\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AddPerm\",\n      \"Effect\": \"Allow\",\n      \"Principal\": \"*\",\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"arn:aws:s3:::yourbucketname/*\"\n    }\n  ]\n}\n```\n\n_And don't forget to replace `yourbucketname` with the name of the bucket you created which has the same name as your domain name.\nAnd don't forget to save the change._\n\n<img alt=\"Bucket policy\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/create-bucket-policy.jpg\">\n\nNow we have to turn on Static Website Hosting in our bucket\n\n_Go to the properties tab and click Static Website Hosting section. Select \"Use this bucket to host a website\" option and put\n`index.html` as the \"Index Document\". you can also put a file name for the \"Error Document\" and save._\n\n<img alt=\"Bucket hosting settings\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/bucket-hosting-settings.jpg\">\n\nOkay, as you can see now we have an address (Endpoint) that can be used to access our hosted website.\nGive it a try and it should return a not found response. that is because we don't have an `index.html` file on our website.\nSo let's add that so we can easily test our website.\n\n_Create two files (`index.html`, `error.html`) and upload it to the root of the bucket.\nI am going to upload files with the content below._\n\n```html\n<html>\n  <body>\n    <h1 style=\"text-align: center; margin-top: 100px;\">\n      We are under construction. please try again later.\n    </h1>\n  </body>\n</html>\n```\n\n```html\n<html>\n  <body>\n    <h1 style=\"text-align: center; margin-top: 100px;\">\n      The page you are trying to access it not available right now\n    </h1>\n  </body>\n</html>\n```\n\nNow if you try the website now, it should return the HTML you have just added. like below. and if you try to access any other file\nIt should return the error page.\n\n<img alt=\"Simple HTML page\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/simple-html-page.jpg\">\n\n#### SSL\n\nWe need SSL for our website. we can use the AWS Certificate Manager to get a free certificate. we will need\nthis when we are creating the Cloudfront distribution.\n\n_Go to the Certificate Manager and create a new Provision Certificate. Make sure you have selected the \"US East (N. Virginia)\" region\nbefore requesting the certificate._\n\n_It will ask you for the domain names to cover with the certificate when you are going ahead. make sure you add your domain name and the domain name with `www` prefix_\n\n<img alt=\"Adding domains to the certificate\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/adding-domains-to-the-certificate.jpg\">\n\n_And go ahead and select DNS validation as the validation method. and request the certificate_\n\nWhile you are in the validation step, you can complete it easily by clicking \"Create record in Route 53\" for each domain name. this will\nautomatically add the required CNAME records to your Route 53 hosted zone.\n\n<img alt=\"Certificate validation\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/certificate-validation.jpg\">\n\nAnd complete the request.\n\nIt will take some time for Amazon to issue the certificate (about 10 minutes).\n\n### CDN With Cloudfront\n\nOkay, now our bucket is ready, let's create the Cloudfront distribution for our site.\n\n_Go to the Cloudfront home page and start creating a new **Web** distribution._\n\n_Copy the URL for our bucket from S3 and paste it **without** the `http://` part into the \"Origin Domain Name\" input._\n\n<img alt=\"S3 bucket URL\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/bucket-url.jpg\">\n\n_Mark the \"Redirect HTTP to HTTPS\" option_\n\n<img alt=\"S3 Bucket redirect HTTP to HTTPS\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/redirect-http-to-https.jpg\">\n\n_Change \"Compress Objects Automatically\" to Yes_\n\n_Put the domain name with and without www prefix in two lines in the \"Alternate Domain Names\" input._\n\n_Select the certificate you created in Certificate Manager as the custom SSL certificate_\n\n<img alt=\"Cloudfront settings\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/cloudfront-settings.jpg\">\n\n_And save changes and wait for it to finish. It will take about 20-30 minutes to deploy the distribution_\n\nAfter the deployment is done, you can check if the website is working by accessing the domain name provided by\nthe distribution.\n\n<img alt=\"Cloudfront default domain\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/cloudfront-domain.jpg\">\n\n_Also make sure that the SSL is working in that domain._\n\n### Setting up the Name Server\n\nWe have our domain ready but it is not working as we have not configured it. So now we are going to configure the name server for the domain name. We can use Route 53 to do this.\n\n_Go to the Route 53 <a target=\"_blank\" href=\"https://console.aws.amazon.com/route53/home#hosted-zones:\">Hosted Zones</a> page and create a new hosted zone._\n\n- Enter the domain name, and keep the type as `Public Hosted Zone` Like below.\n\n<img alt=\"Cloudfront creating hosted zone\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/creating-hosted-zone.jpg\">\n\n_And press `Create` to create the hosted zone._\nNow you will be redirected to the properties page of the newly created hosted zone.\n\nHere you can see they have added some records already. Now we have to let the domain know what is our name server is.\nTo do that we have to add name server records to our domain name.\n\nTo do this we just have to Copy the value of the only NS record in the hosted zone and add them as name server records in our domain.\n\n_Select the name server RecordSet and copy the values (each row represent one NS record)_\n\n<img alt=\"Copying NS records\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/copying-ns-records.jpg\">\n\n_Go to your domain name provider website's management screen and add the name server records you just copied one by one.\nRemove the dot at the end of each record if it gives you an error._\n\n<img alt=\"Add name servers\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/added-name-servers.jpg\">\n\nIt will take some time to switch the name servers depending on your domain name provider. You can check if the name server\nrecords are applied using a tool like <a href=\"https://network-tools.com/nslookup\" target=\"_blank\">NS lookup </a>\n\nNow we just have to point our domain name to the Cloudfront distribution that we just created. To do this, we can create an\nA record that will point to the distribution.\n\n_Go to the hosted zone you created and create a new RecordSet. keep the name empty, Type should be A, Check the Alias option\nand select the CloudFront distribution you created._\n\n<img alt=\"Cloudfront A record config\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/a-record-config.jpg\">\n\n_Also add a new CNAME Record Set to redirect the www subdomain to the root domain So we don't have to configure another\nbucket for that_\n\n<img alt=\"Cloudfront CNAME record config\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/cname-record.jpg\">\n\nThis will take some time to get registered.\n\n---\n\nOkay, now we are mostly done with our AWS setup, now we can go ahead and start setting up our deployment workflow.\nI will keep this website simple with only 4 files,\n\n- error.html\n- index.html\n- index.css\n- index.js\n\nPretty basic setup. And I am going to use Parcel to bundle the files.\n\nThe first thing we have to do is to create a new repository in Gitlab.\n\n_Go ahead and create a new repository_\n\n<img alt=\"Create new repository in Gitlab\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/creating-repository.jpg\">\n\nIn order to access our bucket from Gitlab CI, we will need permissions. for this, we can create a new user\nfor Gitlab CI and assign policies that will allow accessing the bucket we created.\n\n_Go to the AWS IAM console and create a new policy with the below JSON. Don't forget to replace the bucket name (prettyuseless.website) with yours_\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"VisualEditor0\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:PutObject\",\n        \"s3:GetObjectAcl\",\n        \"s3:GetObject\",\n        \"s3:ListBucket\",\n        \"s3:DeleteObject\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::prettyuseless.website/*\",\n        \"arn:aws:s3:::prettyuseless.website\"\n      ]\n    },\n    {\n      \"Sid\": \"VisualEditor1\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:GetAccountPublicAccessBlock\",\n        \"s3:ListAllMyBuckets\",\n        \"s3:ListJobs\",\n        \"s3:CreateJob\",\n        \"s3:HeadBucket\",\n        \"s3:ListObjects\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}\n```\n\n_Set an appropriate name. I am going to name the policy as useless-upload_\n\n_Create a new user. I am going to name it as \"S3GitlabUploader\". You can use whichever name you like.\nAnd make sure Programmatic access is enabled_\n\n<img alt=\"AWS - create a new user\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/aws-user-creation.jpg\">\n\n_Select \"Attach existing policies directly\" and select the policy you created above._\n\n_Remember to keep a copy of the Access key ID and Secret access key that will be prompted at the end of user creation_\n\n<img alt=\"AWS user access keys\" src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/keys.jpg\">\n\nNow we have the credentials to use the bucket. we can now add these access keys to the repository so we can use those values\nin our CI pipeline.\n\nGo to CI/CD Settings and create two variables for the access key and secret key. (put `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`) as the keys.\n\nOkay, with that done, we are ready to configure our CI pipeline.\n\nBelow is the configuration we gonna use.\n\n```yaml\nimage: node:10\n\nstages:\n  - build\n  - deploy\n\nvariables:\n  AWS_DEFAULT_REGION: ap-southeast-1\n  BUCKET_NAME: prettyuseless.website\n\ncache:\n  paths:\n    - vendor\n\nbuildSite:\n  only:\n    - production\n  stage: build\n  script:\n    - npm install -g parcel-bundler --unsafe-perm=true --allow-root\n    - parcel build index.html\n  artifacts:\n    paths:\n      - dist/\n\ndeploys3:\n  only:\n    - production\n  image: \"python:latest\"\n  stage: deploy\n  dependencies:\n    - buildSite\n  before_script:\n    - pip install awscli\n  script:\n    - aws s3 rm s3://${BUCKET_NAME}/ --recursive\n    - aws s3 cp ./dist s3://${BUCKET_NAME}/ --recursive\n  environment:\n    name: ${CI_COMMIT_REF_SLUG}\n    url: http://${BUCKET_NAME}.s3-website.${AWS_DEFAULT_REGION}.amazonaws.com/\n```\n\n_Change the `AWS_DEFAULT_REGION` and `BUCKET_NAME` and save as a file named `.gitlab-ci.yml` in the root of your repository_\n\nThis will instructs Gitlab to build and deploy the website whenever something is pushed to the `production` branch.\nYou can change this behavior if you want.\n\nOkay, now our CI pipeline is ready. I now you can continue developing the website. you just have to push the latest code to the `production` branch,\nIt will deploy the code to S3.\n\n<img alt=\"Pipelines preview\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/pipelines.jpg\">\n\n<img alt=\"Gitlab Job\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/job.jpg\">\n\n<img alt=\"Preview of the final website\"  src=\"$$base_url/post-data/2019-08-14-building-a-website-on-s3/final-website.jpg\">\n","parsedContent":"<p><img alt=\"Page banner\" class=\"Post_banner__soX4H\" src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/banner.png\" ></p>\n<p>S3 supports static site hosting, In this post, I am going to show you how you can set up a website on S3 and configure\na deployment workflow using Gitlab.</p>\n<p>What we can expect from the site that we gonna create?</p>\n<ul>\n<li>It should be fast</li>\n<li>Should have a proper SSL certificate</li>\n<li>Should be able to update the site right from GIT</li>\n</ul>\n<h3 id=\"whatwearegoingtouse\">What we are Going to use</h3>\n<p>Let's see what tools we are going to use to make this happen, Most of these tools are either free or very cost-effective for a\nsimple website. So you can give this a try without any worries. Anyway, it's better to check the pricing and get an understanding before proceeding.</p>\n<p>We are going to spend most of the time in AWS. so if you have not used AWS before, create an account if you want to follow\nalone.</p>\n<h5 id=\"adomainnameservice\">A domain name service</h5>\n<p>I am going to use Godaddy. but you can use any service for this. We use this only to buy the domain.\nafter adding the name server records, we won't touch this much.</p>\n<h5 id=\"amazonroute53\">Amazon Route 53</h5>\n<p>We are going to use Amazon Route 53 as the name server for our domain.</p>\n<h5 id=\"amazoncertificatemanager\">Amazon Certificate Manager</h5>\n<p>We will need the Certificate Manager to get an SSL certificate for our website</p>\n<h5 id=\"amazoncloudfront\">Amazon Cloudfront</h5>\n<p>We have to use a Cloudfront distribution for our website.</p>\n<h5 id=\"amazons3\">Amazon S3</h5>\n<p>We are going to use S3 to put the files of the website (the site itself)</p>\n<h5 id=\"gitlab\">Gitlab</h5>\n<p>We will use Gitlab to host our code and create the CI pipeline. create a new account if you haven't used it before if you want to follow along. its free.</p>\n<h3 id=\"gettingadomainnameready\">Getting a Domain Name Ready</h3>\n<p>If you have a domain name already, skip this step. You can use any domain name service as you like such as NameCheap, BlueHost.</p>\n<p>I already have a domain that can be used in this which is <code>prettyuseless.website</code>.\nThe name is awful but let's continue with it.</p>\n<p>So I have my domain name with me, make sure you have your one ready at this point if you follow along.</p>\n<h3 id=\"creatingthes3bucket\">Creating the S3 Bucket</h3>\n<p>Okay, we need a place to put the files of our website (such as <code>index.html</code>). we are going to use Amazon S3 for this.\nFirst, we have to create a bucket for our website. Make sure to set the domain name as the name of the new bucket.</p>\n<p><em>Go to S3 home page, and start creating the bucket. put your domain name as the name and choose your preferred region.\n(I am choosing Singapore) and go head</em></p>\n<p><img alt=\"Create a bucket\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/create-bucket-step-one.jpg\"></p>\n<p>After creating the bucket, It should immediately show up in the S3 home page.</p>\n<p><em>Click the bucket you just created and go to permissions tab. Click the \"Bucket Policy\" button and paste the configuration below</em></p>\n<pre><code class=\"hljs json language-json\"><span class=\"hljs-punctuation\">{</span>\n  <span class=\"hljs-attr\">&quot;Version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2012-10-17&quot;</span><span class=\"hljs-punctuation\">,</span>\n  <span class=\"hljs-attr\">&quot;Statement&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span>\n    <span class=\"hljs-punctuation\">{</span>\n      <span class=\"hljs-attr\">&quot;Sid&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;AddPerm&quot;</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Effect&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Allow&quot;</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Principal&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;*&quot;</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Action&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;s3:GetObject&quot;</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Resource&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;arn:aws:s3:::yourbucketname/*&quot;</span>\n    <span class=\"hljs-punctuation\">}</span>\n  <span class=\"hljs-punctuation\">]</span>\n<span class=\"hljs-punctuation\">}</span>\n</code></pre>\n<p><em>And don't forget to replace <code>yourbucketname</code> with the name of the bucket you created which has the same name as your domain name.\nAnd don't forget to save the change.</em></p>\n<p><img alt=\"Bucket policy\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/create-bucket-policy.jpg\"></p>\n<p>Now we have to turn on Static Website Hosting in our bucket</p>\n<p><em>Go to the properties tab and click Static Website Hosting section. Select \"Use this bucket to host a website\" option and put\n<code>index.html</code> as the \"Index Document\". you can also put a file name for the \"Error Document\" and save.</em></p>\n<p><img alt=\"Bucket hosting settings\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/bucket-hosting-settings.jpg\"></p>\n<p>Okay, as you can see now we have an address (Endpoint) that can be used to access our hosted website.\nGive it a try and it should return a not found response. that is because we don't have an <code>index.html</code> file on our website.\nSo let's add that so we can easily test our website.</p>\n<p><em>Create two files (<code>index.html</code>, <code>error.html</code>) and upload it to the root of the bucket.\nI am going to upload files with the content below.</em></p>\n<pre><code class=\"hljs html language-html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">&quot;text-align: center; margin-top: 100px;&quot;</span>&gt;</span>\n      We are under construction. please try again later.\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span>\n</code></pre>\n<pre><code class=\"hljs html language-html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">&quot;text-align: center; margin-top: 100px;&quot;</span>&gt;</span>\n      The page you are trying to access it not available right now\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span>\n</code></pre>\n<p>Now if you try the website now, it should return the HTML you have just added. like below. and if you try to access any other file\nIt should return the error page.</p>\n<p><img alt=\"Simple HTML page\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/simple-html-page.jpg\"></p>\n<h4 id=\"ssl\">SSL</h4>\n<p>We need SSL for our website. we can use the AWS Certificate Manager to get a free certificate. we will need\nthis when we are creating the Cloudfront distribution.</p>\n<p><em>Go to the Certificate Manager and create a new Provision Certificate. Make sure you have selected the \"US East (N. Virginia)\" region\nbefore requesting the certificate.</em></p>\n<p><em>It will ask you for the domain names to cover with the certificate when you are going ahead. make sure you add your domain name and the domain name with <code>www</code> prefix</em></p>\n<p><img alt=\"Adding domains to the certificate\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/adding-domains-to-the-certificate.jpg\"></p>\n<p><em>And go ahead and select DNS validation as the validation method. and request the certificate</em></p>\n<p>While you are in the validation step, you can complete it easily by clicking \"Create record in Route 53\" for each domain name. this will\nautomatically add the required CNAME records to your Route 53 hosted zone.</p>\n<p><img alt=\"Certificate validation\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/certificate-validation.jpg\"></p>\n<p>And complete the request.</p>\n<p>It will take some time for Amazon to issue the certificate (about 10 minutes).</p>\n<h3 id=\"cdnwithcloudfront\">CDN With Cloudfront</h3>\n<p>Okay, now our bucket is ready, let's create the Cloudfront distribution for our site.</p>\n<p><em>Go to the Cloudfront home page and start creating a new <strong>Web</strong> distribution.</em></p>\n<p><em>Copy the URL for our bucket from S3 and paste it <strong>without</strong> the <code>http://</code> part into the \"Origin Domain Name\" input.</em></p>\n<p><img alt=\"S3 bucket URL\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/bucket-url.jpg\"></p>\n<p><em>Mark the \"Redirect HTTP to HTTPS\" option</em></p>\n<p><img alt=\"S3 Bucket redirect HTTP to HTTPS\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/redirect-http-to-https.jpg\"></p>\n<p><em>Change \"Compress Objects Automatically\" to Yes</em></p>\n<p><em>Put the domain name with and without www prefix in two lines in the \"Alternate Domain Names\" input.</em></p>\n<p><em>Select the certificate you created in Certificate Manager as the custom SSL certificate</em></p>\n<p><img alt=\"Cloudfront settings\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/cloudfront-settings.jpg\"></p>\n<p><em>And save changes and wait for it to finish. It will take about 20-30 minutes to deploy the distribution</em></p>\n<p>After the deployment is done, you can check if the website is working by accessing the domain name provided by\nthe distribution.</p>\n<p><img alt=\"Cloudfront default domain\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/cloudfront-domain.jpg\"></p>\n<p><em>Also make sure that the SSL is working in that domain.</em></p>\n<h3 id=\"settingupthenameserver\">Setting up the Name Server</h3>\n<p>We have our domain ready but it is not working as we have not configured it. So now we are going to configure the name server for the domain name. We can use Route 53 to do this.</p>\n<p><em>Go to the Route 53 <a target=\"_blank\" href=\"https://console.aws.amazon.com/route53/home#hosted-zones:\">Hosted Zones</a> page and create a new hosted zone.</em></p>\n<ul>\n<li>Enter the domain name, and keep the type as <code>Public Hosted Zone</code> Like below.</li>\n</ul>\n<p><img alt=\"Cloudfront creating hosted zone\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/creating-hosted-zone.jpg\"></p>\n<p><em>And press <code>Create</code> to create the hosted zone.</em>\nNow you will be redirected to the properties page of the newly created hosted zone.</p>\n<p>Here you can see they have added some records already. Now we have to let the domain know what is our name server is.\nTo do that we have to add name server records to our domain name.</p>\n<p>To do this we just have to Copy the value of the only NS record in the hosted zone and add them as name server records in our domain.</p>\n<p><em>Select the name server RecordSet and copy the values (each row represent one NS record)</em></p>\n<p><img alt=\"Copying NS records\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/copying-ns-records.jpg\"></p>\n<p><em>Go to your domain name provider website's management screen and add the name server records you just copied one by one.\nRemove the dot at the end of each record if it gives you an error.</em></p>\n<p><img alt=\"Add name servers\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/added-name-servers.jpg\"></p>\n<p>It will take some time to switch the name servers depending on your domain name provider. You can check if the name server\nrecords are applied using a tool like <a href=\"https://network-tools.com/nslookup\" target=\"_blank\">NS lookup </a></p>\n<p>Now we just have to point our domain name to the Cloudfront distribution that we just created. To do this, we can create an\nA record that will point to the distribution.</p>\n<p><em>Go to the hosted zone you created and create a new RecordSet. keep the name empty, Type should be A, Check the Alias option\nand select the CloudFront distribution you created.</em></p>\n<p><img alt=\"Cloudfront A record config\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/a-record-config.jpg\"></p>\n<p><em>Also add a new CNAME Record Set to redirect the www subdomain to the root domain So we don't have to configure another\nbucket for that</em></p>\n<p><img alt=\"Cloudfront CNAME record config\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/cname-record.jpg\"></p>\n<p>This will take some time to get registered.</p>\n<hr />\n<p>Okay, now we are mostly done with our AWS setup, now we can go ahead and start setting up our deployment workflow.\nI will keep this website simple with only 4 files,</p>\n<ul>\n<li>error.html</li>\n<li>index.html</li>\n<li>index.css</li>\n<li>index.js</li>\n</ul>\n<p>Pretty basic setup. And I am going to use Parcel to bundle the files.</p>\n<p>The first thing we have to do is to create a new repository in Gitlab.</p>\n<p><em>Go ahead and create a new repository</em></p>\n<p><img alt=\"Create new repository in Gitlab\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/creating-repository.jpg\"></p>\n<p>In order to access our bucket from Gitlab CI, we will need permissions. for this, we can create a new user\nfor Gitlab CI and assign policies that will allow accessing the bucket we created.</p>\n<p><em>Go to the AWS IAM console and create a new policy with the below JSON. Don't forget to replace the bucket name (prettyuseless.website) with yours</em></p>\n<pre><code class=\"hljs json language-json\"><span class=\"hljs-punctuation\">{</span>\n  <span class=\"hljs-attr\">&quot;Version&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;2012-10-17&quot;</span><span class=\"hljs-punctuation\">,</span>\n  <span class=\"hljs-attr\">&quot;Statement&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span>\n    <span class=\"hljs-punctuation\">{</span>\n      <span class=\"hljs-attr\">&quot;Sid&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VisualEditor0&quot;</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Effect&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Allow&quot;</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Action&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span>\n        <span class=\"hljs-string\">&quot;s3:PutObject&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:GetObjectAcl&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:GetObject&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:ListBucket&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:DeleteObject&quot;</span>\n      <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Resource&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span>\n        <span class=\"hljs-string\">&quot;arn:aws:s3:::prettyuseless.website/*&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;arn:aws:s3:::prettyuseless.website&quot;</span>\n      <span class=\"hljs-punctuation\">]</span>\n    <span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n    <span class=\"hljs-punctuation\">{</span>\n      <span class=\"hljs-attr\">&quot;Sid&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;VisualEditor1&quot;</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Effect&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;Allow&quot;</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Action&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span>\n        <span class=\"hljs-string\">&quot;s3:GetAccountPublicAccessBlock&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:ListAllMyBuckets&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:ListJobs&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:CreateJob&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:HeadBucket&quot;</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">&quot;s3:ListObjects&quot;</span>\n      <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">&quot;Resource&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;*&quot;</span>\n    <span class=\"hljs-punctuation\">}</span>\n  <span class=\"hljs-punctuation\">]</span>\n<span class=\"hljs-punctuation\">}</span>\n</code></pre>\n<p><em>Set an appropriate name. I am going to name the policy as useless-upload</em></p>\n<p><em>Create a new user. I am going to name it as \"S3GitlabUploader\". You can use whichever name you like.\nAnd make sure Programmatic access is enabled</em></p>\n<p><img alt=\"AWS - create a new user\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/aws-user-creation.jpg\"></p>\n<p><em>Select \"Attach existing policies directly\" and select the policy you created above.</em></p>\n<p><em>Remember to keep a copy of the Access key ID and Secret access key that will be prompted at the end of user creation</em></p>\n<p><img alt=\"AWS user access keys\" src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/keys.jpg\"></p>\n<p>Now we have the credentials to use the bucket. we can now add these access keys to the repository so we can use those values\nin our CI pipeline.</p>\n<p>Go to CI/CD Settings and create two variables for the access key and secret key. (put <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>) as the keys.</p>\n<p>Okay, with that done, we are ready to configure our CI pipeline.</p>\n<p>Below is the configuration we gonna use.</p>\n<pre><code class=\"hljs yaml language-yaml\"><span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">node:10</span>\n\n<span class=\"hljs-attr\">stages:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">build</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">deploy</span>\n\n<span class=\"hljs-attr\">variables:</span>\n  <span class=\"hljs-attr\">AWS_DEFAULT_REGION:</span> <span class=\"hljs-string\">ap-southeast-1</span>\n  <span class=\"hljs-attr\">BUCKET_NAME:</span> <span class=\"hljs-string\">prettyuseless.website</span>\n\n<span class=\"hljs-attr\">cache:</span>\n  <span class=\"hljs-attr\">paths:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">vendor</span>\n\n<span class=\"hljs-attr\">buildSite:</span>\n  <span class=\"hljs-attr\">only:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">production</span>\n  <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">build</span>\n  <span class=\"hljs-attr\">script:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">-g</span> <span class=\"hljs-string\">parcel-bundler</span> <span class=\"hljs-string\">--unsafe-perm=true</span> <span class=\"hljs-string\">--allow-root</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">parcel</span> <span class=\"hljs-string\">build</span> <span class=\"hljs-string\">index.html</span>\n  <span class=\"hljs-attr\">artifacts:</span>\n    <span class=\"hljs-attr\">paths:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">dist/</span>\n\n<span class=\"hljs-attr\">deploys3:</span>\n  <span class=\"hljs-attr\">only:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">production</span>\n  <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">&quot;python:latest&quot;</span>\n  <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">deploy</span>\n  <span class=\"hljs-attr\">dependencies:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">buildSite</span>\n  <span class=\"hljs-attr\">before_script:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">pip</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">awscli</span>\n  <span class=\"hljs-attr\">script:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">aws</span> <span class=\"hljs-string\">s3</span> <span class=\"hljs-string\">rm</span> <span class=\"hljs-string\">s3://${BUCKET_NAME}/</span> <span class=\"hljs-string\">--recursive</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">aws</span> <span class=\"hljs-string\">s3</span> <span class=\"hljs-string\">cp</span> <span class=\"hljs-string\">./dist</span> <span class=\"hljs-string\">s3://${BUCKET_NAME}/</span> <span class=\"hljs-string\">--recursive</span>\n  <span class=\"hljs-attr\">environment:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">${CI_COMMIT_REF_SLUG}</span>\n    <span class=\"hljs-attr\">url:</span> <span class=\"hljs-string\">http://${BUCKET_NAME}.s3-website.${AWS_DEFAULT_REGION}.amazonaws.com/</span>\n</code></pre>\n<p><em>Change the <code>AWS_DEFAULT_REGION</code> and <code>BUCKET_NAME</code> and save as a file named <code>.gitlab-ci.yml</code> in the root of your repository</em></p>\n<p>This will instructs Gitlab to build and deploy the website whenever something is pushed to the <code>production</code> branch.\nYou can change this behavior if you want.</p>\n<p>Okay, now our CI pipeline is ready. I now you can continue developing the website. you just have to push the latest code to the <code>production</code> branch,\nIt will deploy the code to S3.</p>\n<p><img alt=\"Pipelines preview\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/pipelines.jpg\"></p>\n<p><img alt=\"Gitlab Job\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/job.jpg\"></p>\n<p><img alt=\"Preview of the final website\"  src=\"https://rusith.me/post-data/2019-08-14-building-a-website-on-s3/final-website.jpg\"></p>"},"page":"Post","topTags":["programming","aws","web","machineLearning","react","javascript","dataScience","typescript","r","csharp"],"relatedPosts":[{"title":"Deploying an app on AWS ECS with CDK","tags":["programming","nextJS","react","aws","ecs","typescript","cdk","devops"],"fullUrl":"https://rusith.me/blog/deploy-app-on-aws-ecs-with-cdk-auto-scaling-and-load-balancing","date":"Wed, Feb 15, 2023","description":"How to deploy an application on AWS ECS with load-balancing and auto-scaling using CDK by writing the CDK code in TypeScript","banner":"/post-data/2023-02-15-deploying-react-app-on-ecs/banner.png"},{"title":"Running a Nuget Feed on S3 with Automated Deployments","tags":["programming","dotnet","s3","aws","nuget"],"fullUrl":"https://rusith.me/blog/nuget-feed-on-s3","date":"Sat, Nov 2, 2019","description":"There are many ways of creating a Nuget feed. but did you know that you can run a Nuget feed on S3 without any computing infrastructure? In this post, I will show you how you can create a Nuget feed on S3 using Sleet and automate the deployment process for packages.","banner":"/post-data/2019-11-03-nuget-feed-s3/banner.png"},{"title":"Creating a Re-Usable Presto Worker Image in EC2","tags":["programming","bigdata","aws","cloud"],"fullUrl":"https://rusith.me/blog/re-usable-presto-worker-image-ec2","date":"Thu, Jul 25, 2019","description":"Creating a machine image that can be used to spin up presto worker instances without configuring each one. this could be helpful when you don't want to use any  orchestration tool","banner":"/post-data/2019-07-25-re-usable-presto-worker/5-workers-dashboard.png"}]},"__N_SSG":true}